<!DOCTYPE HTML>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paul Graham Essays</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>Paul Graham Essays</h1>
    </header>

    <div class="main-content">
        <div class="filters-sidebar">
            <div class="filter-group">
                <label class="filter-label">View</label>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="toggleView('all')">All</button>
                    <button class="filter-btn" onclick="toggleView('bookmarked')">Bookmarked</button>
                </div>
            </div>

            <div class="section-divider">
                <h3 class="section-title">Filter</h3>
            </div>

            <div class="filter-group">
                <label class="filter-label collapsed" onclick="toggleFilterSection(this)">Topics</label>
                <div class="filter-content collapsed">
                    <div id="topicTree" class="topic-tree"></div>
                </div>
            </div>

            <div class="filter-group">
                <label class="filter-label collapsed" onclick="toggleFilterSection(this)">Essay Type</label>
                <div class="filter-content collapsed">
                    <div id="essayTypeTree" class="topic-tree"></div>
                </div>
            </div>

            <div class="filter-group">
                <label class="filter-label collapsed" onclick="toggleFilterSection(this)">Audience</label>
                <div class="filter-content collapsed">
                    <div id="audienceTree" class="topic-tree"></div>
                </div>
            </div>

            <div class="filter-group">
                <label class="filter-label collapsed" onclick="toggleFilterSection(this)">Reading Time (min)</label>
                <div class="filter-content collapsed">
                    <div class="dual-slider-container">
                        <input type="range" id="timeMinSlider" class="dual-slider dual-slider-min" min="5" max="70" step="5" value="5" oninput="updateTimeLabels(); applySortAndFilter()">
                        <input type="range" id="timeMaxSlider" class="dual-slider dual-slider-max" min="5" max="70" step="5" value="70" oninput="updateTimeLabels(); applySortAndFilter()">
                    </div>
                    <div class="slider-label"><span id="timeMinLabel">5</span> - <span id="timeMaxLabel">70</span> min</div>
                </div>
            </div>

            <div class="filter-group">
                <label class="filter-label collapsed" onclick="toggleFilterSection(this)">Year</label>
                <div class="filter-content collapsed">
                    <div class="dual-slider-container">
                        <input type="range" id="yearMinSlider" class="dual-slider dual-slider-min" min="1996" max="2025" value="1996" oninput="updateYearLabels(); applySortAndFilter()">
                        <input type="range" id="yearMaxSlider" class="dual-slider dual-slider-max" min="1996" max="2025" value="2025" oninput="updateYearLabels(); applySortAndFilter()">
                    </div>
                    <div class="slider-label"><span id="yearMinLabel">1996</span> - <span id="yearMaxLabel">2025</span></div>
                </div>
            </div>

            <div class="section-divider">
                <h3 class="section-title">Sort</h3>
            </div>

            <div class="filter-group">
                <label class="filter-label collapsed" onclick="toggleFilterSection(this)">Date</label>
                <div class="filter-content collapsed">
                    <div class="topic-tree" id="dateSortTree">
                        <div class="tree-item" onclick="setSortOption('date-desc')">
                            <span class="tree-item-label">Newest First</span>
                        </div>
                        <div class="tree-item" onclick="setSortOption('date-asc')">
                            <span class="tree-item-label">Oldest First</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="filter-group">
                <label class="filter-label collapsed" onclick="toggleFilterSection(this)">Length</label>
                <div class="filter-content collapsed">
                    <div class="topic-tree" id="lengthSortTree">
                        <div class="tree-item" onclick="setSortOption('length-desc')">
                            <span class="tree-item-label">Longest First</span>
                        </div>
                        <div class="tree-item" onclick="setSortOption('length-asc')">
                            <span class="tree-item-label">Shortest First</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="middle-pane">
            <div class="essay-count" id="essayCount"></div>
            <div id="essayList"></div>
        </div>

        <div class="right-pane" id="rightPane">
            <div class="preview-header">
                <div class="preview-title" id="previewTitle"></div>
                <button class="close-preview-btn" onclick="closePreview()">Close Preview</button>
            </div>
            <div class="preview-container" id="previewContainer"></div>
        </div>
    </div>

    <script>
        // ========== BOOKMARK FUNCTIONS ==========

        function getBookmarks() {
            return JSON.parse(localStorage.getItem('pg-bookmarks') || '[]');
        }

        function isBookmarked(title) {
            return getBookmarks().includes(title);
        }

        function toggleBookmark(title) {
            let bookmarks = getBookmarks();

            if (bookmarks.includes(title)) {
                bookmarks = bookmarks.filter(b => b !== title);
            } else {
                bookmarks.push(title);
            }

            localStorage.setItem('pg-bookmarks', JSON.stringify(bookmarks));

            // Update the star icon without reloading
            updateBookmarkButton(title);

            // Refresh the list if we're in bookmarked view
            if (currentView === 'bookmarked') {
                applySortAndFilter();
            }
        }

        function updateBookmarkButton(title) {
            const buttons = document.querySelectorAll(`[data-title="${title}"]`);
            buttons.forEach(btn => {
                if (isBookmarked(title)) {
                    btn.classList.add('bookmarked');
                    btn.innerHTML = '★';
                } else {
                    btn.classList.remove('bookmarked');
                    btn.innerHTML = '☆';
                }
            });
        }

        // ========== PREVIEW FUNCTIONS ==========

        function openPreview(essay) {
            const rightPane = document.getElementById('rightPane');
            const previewTitle = document.getElementById('previewTitle');
            const previewContainer = document.getElementById('previewContainer');

            previewTitle.textContent = essay.Title;
            previewContainer.innerHTML = `<iframe class="preview-iframe" src="${essay.URL}"></iframe>`;
            rightPane.classList.add('visible');
        }

        function closePreview() {
            const rightPane = document.getElementById('rightPane');
            rightPane.classList.remove('visible');
        }

        // ========== FILTER SECTION COLLAPSE ==========

        function toggleFilterSection(labelElement) {
            const content = labelElement.nextElementSibling;
            labelElement.classList.toggle('collapsed');
            content.classList.toggle('collapsed');
        }

        // ========== LIST RENDERING ==========

        let allEssays = [];
        let currentView = 'all'; // 'all' or 'bookmarked'
        let currentSort = 'date-desc';
        let primarySort = 'date-desc'; // Primary sort criterion
        let secondarySort = null; // Secondary sort criterion
        let selectedTopicPath = []; // Tracks selected topic path [topic, category, item]
        let selectedEssayType = null; // Tracks selected essay type
        let selectedAudience = null; // Tracks selected audience

        function toggleView(view) {
            currentView = view;

            // Update button states
            const buttons = document.querySelectorAll('.filter-buttons .filter-btn:not(.sort-btn)');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            applySortAndFilter();
        }

        function setSortOption(sortType) {
            const clickedItem = event.target.closest('.tree-item');
            const sortCategory = sortType.startsWith('date') ? 'date' : 'length';

            // Check if clicking on already selected sort to deselect it
            if (sortType === primarySort) {
                // Deselecting primary - promote secondary to primary
                primarySort = secondarySort || 'date-desc'; // Default to date-desc if no secondary
                currentSort = primarySort;
                secondarySort = null;
            } else if (sortType === secondarySort) {
                // Deselecting secondary
                secondarySort = null;
            } else {
                // Determine if this becomes primary or secondary
                if (!primarySort || primarySort.startsWith(sortCategory)) {
                    // First selection or clicking within same category - make it primary
                    primarySort = sortType;
                    currentSort = sortType;
                } else {
                    // Clicking different category - make it secondary
                    secondarySort = sortType;
                }
            }

            // Update the UI
            updateSortBadges();
            applySortAndFilter();
        }

        function updateSortBadges() {
            // Remove all badges and selected states
            document.querySelectorAll('#dateSortTree .tree-item, #lengthSortTree .tree-item').forEach(item => {
                item.classList.remove('selected');
                const existingBadge = item.querySelector('.sort-number');
                if (existingBadge) {
                    existingBadge.remove();
                }
            });

            // Add badge to primary sort
            if (primarySort) {
                const primaryItem = findSortItem(primarySort);
                if (primaryItem) {
                    primaryItem.classList.add('selected');
                    const badge = document.createElement('span');
                    badge.className = 'sort-number';
                    badge.textContent = '1';
                    primaryItem.querySelector('.tree-item-label').appendChild(badge);
                }
            }

            // Add badge to secondary sort
            if (secondarySort) {
                const secondaryItem = findSortItem(secondarySort);
                if (secondaryItem) {
                    secondaryItem.classList.add('selected');
                    const badge = document.createElement('span');
                    badge.className = 'sort-number';
                    badge.textContent = '2';
                    secondaryItem.querySelector('.tree-item-label').appendChild(badge);
                }
            }
        }

        function findSortItem(sortType) {
            const allSortItems = document.querySelectorAll('#dateSortTree .tree-item, #lengthSortTree .tree-item');
            for (let item of allSortItems) {
                if (item.getAttribute('onclick')?.includes(sortType)) {
                    return item;
                }
            }
            return null;
        }

        function updateTimeLabels() {
            const minSlider = document.getElementById('timeMinSlider');
            const maxSlider = document.getElementById('timeMaxSlider');
            let minValue = parseInt(minSlider.value);
            let maxValue = parseInt(maxSlider.value);

            // Ensure min doesn't exceed max
            if (minValue > maxValue) {
                minSlider.value = maxValue;
                minValue = maxValue;
            }

            document.getElementById('timeMinLabel').textContent = minValue;
            document.getElementById('timeMaxLabel').textContent = maxValue;
        }

        function updateYearLabels() {
            const minSlider = document.getElementById('yearMinSlider');
            const maxSlider = document.getElementById('yearMaxSlider');
            let minValue = parseInt(minSlider.value);
            let maxValue = parseInt(maxSlider.value);

            // Ensure min doesn't exceed max
            if (minValue > maxValue) {
                minSlider.value = maxValue;
                minValue = maxValue;
            }

            document.getElementById('yearMinLabel').textContent = minValue;
            document.getElementById('yearMaxLabel').textContent = maxValue;
        }

        function applySortAndFilter() {
            let essays = [...allEssays];

            // Filter by view (all or bookmarked)
            if (currentView === 'bookmarked') {
                const bookmarks = getBookmarks();
                essays = essays.filter(essay => bookmarks.includes(essay.Title));
            }

            // Filter by topic tree selection
            if (selectedTopicPath.length > 0) {
                essays = essays.filter(essay => {
                    return essay.Topics.some(t => {
                        const [topic, secondLevel, thirdLevel] = selectedTopicPath;

                        // Check if topic matches
                        if (t.topic !== topic) return false;

                        // If only topic is selected, include all essays with this topic
                        if (!secondLevel) return true;

                        // Check if we have a two-level or three-level path
                        if (!thirdLevel) {
                            // Two-level path: could be [topic, directItem] or [topic, category]
                            if (t.subtopics) {
                                // Check if secondLevel is a direct item (no category) or a category
                                return t.subtopics.some(subObj => {
                                    // Check if it's a direct item
                                    if (!subObj.category && subObj.items && subObj.items.includes(secondLevel)) {
                                        return true;
                                    }
                                    // Check if it's a category
                                    if (subObj.category === secondLevel) {
                                        return true;
                                    }
                                    return false;
                                });
                            }
                            return false;
                        } else {
                            // Three-level path: [topic, category, item]
                            if (t.subtopics) {
                                return t.subtopics.some(subObj => {
                                    return subObj.category === secondLevel &&
                                           subObj.items &&
                                           subObj.items.includes(thirdLevel);
                                });
                            }
                            return false;
                        }
                    });
                });
            }

            // Filter by essay type
            if (selectedEssayType) {
                essays = essays.filter(essay =>
                    essay.EssayType && essay.EssayType.includes(selectedEssayType)
                );
            }

            // Filter by audience
            if (selectedAudience) {
                essays = essays.filter(essay =>
                    essay.Audience && essay.Audience.includes(selectedAudience)
                );
            }

            // Filter by reading time (sliders)
            const minTime = parseInt(document.getElementById('timeMinSlider').value);
            const maxTime = parseInt(document.getElementById('timeMaxSlider').value);
            essays = essays.filter(essay => essay.ReadingTime >= minTime && essay.ReadingTime <= maxTime);

            // Filter by year (sliders)
            const minYear = parseInt(document.getElementById('yearMinSlider').value);
            const maxYear = parseInt(document.getElementById('yearMaxSlider').value);
            essays = essays.filter(essay => essay.Year >= minYear && essay.Year <= maxYear);

            // Sort - with primary and secondary criteria
            essays.sort((a, b) => {
                // Apply primary sort
                let primaryResult = 0;
                switch(primarySort) {
                    case 'date-desc':
                        primaryResult = b.Year - a.Year;
                        break;
                    case 'date-asc':
                        primaryResult = a.Year - b.Year;
                        break;
                    case 'length-desc':
                        primaryResult = b.WordCount - a.WordCount;
                        break;
                    case 'length-asc':
                        primaryResult = a.WordCount - b.WordCount;
                        break;
                }

                // If primary sort values are equal and there's a secondary sort, apply it
                if (primaryResult === 0 && secondarySort) {
                    switch(secondarySort) {
                        case 'date-desc':
                            return b.Year - a.Year;
                        case 'date-asc':
                            return a.Year - b.Year;
                        case 'length-desc':
                            return b.WordCount - a.WordCount;
                        case 'length-asc':
                            return a.WordCount - b.WordCount;
                    }
                }

                return primaryResult;
            });

            renderList(essays);
        }

        // ========== TOPIC TREE FUNCTIONS ==========

        function createTreeItem(label, count, level, onClick) {
            const item = document.createElement('div');
            item.className = 'tree-item';
            if (level > 1) {
                item.classList.add(`tree-level-${level}`);
            }

            const labelSpan = document.createElement('span');
            labelSpan.className = 'tree-item-label';
            labelSpan.textContent = label;

            const badge = document.createElement('span');
            badge.className = 'count-badge';
            badge.textContent = count;

            item.appendChild(labelSpan);
            item.appendChild(badge);
            item.onclick = (e) => {
                e.stopPropagation();
                onClick();
            };

            return item;
        }

        function handleTopicClick(topicName) {
            // Clear previous selection
            selectedTopicPath = [topicName];

            // Toggle expansion
            const childrenContainer = document.getElementById(`children-${topicName}`);
            const wasExpanded = childrenContainer.classList.contains('expanded');

            // Collapse all other topics
            document.querySelectorAll('.tree-children').forEach(el => el.classList.remove('expanded'));
            document.querySelectorAll('.tree-item').forEach(el => el.classList.remove('selected'));

            if (!wasExpanded) {
                childrenContainer.classList.add('expanded');
            } else {
                selectedTopicPath = [];
            }

            updateTreeSelection();
            applySortAndFilter();
        }

        function handleCategoryClick(topicName, categoryName) {
            selectedTopicPath = [topicName, categoryName];

            // Toggle expansion
            const childrenContainer = document.getElementById(`children-${topicName}-${categoryName}`);
            const wasExpanded = childrenContainer.classList.contains('expanded');

            // Collapse all category children
            document.querySelectorAll(`[id^="children-${topicName}-"]`).forEach(el => {
                if (el.id !== `children-${topicName}`) {
                    el.classList.remove('expanded');
                }
            });

            if (!wasExpanded) {
                childrenContainer.classList.add('expanded');
            } else {
                selectedTopicPath = [topicName];
            }

            updateTreeSelection();
            applySortAndFilter();
        }

        function handleDirectItemClick(topicName, itemName) {
            // For two-level structure (no category)
            selectedTopicPath = [topicName, itemName];
            updateTreeSelection();
            applySortAndFilter();
        }

        function handleItemClick(topicName, categoryName, itemName) {
            // For three-level structure (with category)
            selectedTopicPath = [topicName, categoryName, itemName];
            updateTreeSelection();
            applySortAndFilter();
        }

        function updateTreeSelection() {
            // Remove all selected states
            document.querySelectorAll('.tree-item').forEach(el => el.classList.remove('selected'));

            // Add selected state to items in the path
            if (selectedTopicPath.length > 0) {
                // Find and select based on path
                const topicItems = document.querySelectorAll('#topicTree .tree-item');
                topicItems.forEach(item => {
                    const label = item.querySelector('.tree-item-label').textContent;
                    if (selectedTopicPath.includes(label)) {
                        item.classList.add('selected');
                    }
                });
            }

            // Update essay type selection
            if (selectedEssayType) {
                const essayTypeItems = document.querySelectorAll('#essayTypeTree .tree-item');
                essayTypeItems.forEach(item => {
                    const label = item.querySelector('.tree-item-label').textContent;
                    if (label === selectedEssayType) {
                        item.classList.add('selected');
                    }
                });
            }

            // Update audience selection
            if (selectedAudience) {
                const audienceItems = document.querySelectorAll('#audienceTree .tree-item');
                audienceItems.forEach(item => {
                    const label = item.querySelector('.tree-item-label').textContent;
                    if (label === selectedAudience) {
                        item.classList.add('selected');
                    }
                });
            }
        }

        function handleEssayTypeClick(essayType) {
            // Toggle selection
            if (selectedEssayType === essayType) {
                selectedEssayType = null;
            } else {
                selectedEssayType = essayType;
            }
            updateTreeSelection();
            applySortAndFilter();
        }

        function handleAudienceClick(audience) {
            // Toggle selection
            if (selectedAudience === audience) {
                selectedAudience = null;
            } else {
                selectedAudience = audience;
            }
            updateTreeSelection();
            applySortAndFilter();
        }

        function populateFilters() {
            // Build topic hierarchy with counts
            const topicHierarchy = {};

            allEssays.forEach(essay => {
                essay.Topics.forEach(t => {
                    const topicName = t.topic;

                    if (!topicHierarchy[topicName]) {
                        topicHierarchy[topicName] = { count: 0, categories: {}, directItems: {} };
                    }
                    topicHierarchy[topicName].count++;

                    if (t.subtopics) {
                        t.subtopics.forEach(subObj => {
                            if (subObj.category && subObj.items) {
                                // Has category - three level structure
                                const categoryName = subObj.category;

                                if (!topicHierarchy[topicName].categories[categoryName]) {
                                    topicHierarchy[topicName].categories[categoryName] = { count: 0, items: {} };
                                }
                                topicHierarchy[topicName].categories[categoryName].count++;

                                subObj.items.forEach(item => {
                                    if (!topicHierarchy[topicName].categories[categoryName].items[item]) {
                                        topicHierarchy[topicName].categories[categoryName].items[item] = 0;
                                    }
                                    topicHierarchy[topicName].categories[categoryName].items[item]++;
                                });
                            } else if (subObj.items) {
                                // No category - two level structure (direct items under topic)
                                subObj.items.forEach(item => {
                                    if (!topicHierarchy[topicName].directItems[item]) {
                                        topicHierarchy[topicName].directItems[item] = 0;
                                    }
                                    topicHierarchy[topicName].directItems[item]++;
                                });
                            }
                        });
                    }
                });
            });

            // Build the tree UI
            const topicTree = document.getElementById('topicTree');
            topicTree.innerHTML = '';

            // Sort topics by count (descending)
            Object.keys(topicHierarchy).sort((a, b) => topicHierarchy[b].count - topicHierarchy[a].count).forEach(topicName => {
                const topicData = topicHierarchy[topicName];
                const topicItem = createTreeItem(topicName, topicData.count, 1, () => handleTopicClick(topicName));
                topicTree.appendChild(topicItem);

                // Create children container
                const childrenContainer = document.createElement('div');
                childrenContainer.className = 'tree-children';
                childrenContainer.id = `children-${topicName}`;

                // Add direct items (two-level structure)
                Object.keys(topicData.directItems).sort().forEach(itemName => {
                    const itemCount = topicData.directItems[itemName];
                    const itemElement = createTreeItem(itemName, itemCount, 2, () => handleDirectItemClick(topicName, itemName));
                    childrenContainer.appendChild(itemElement);
                });

                // Add categories (three-level structure)
                Object.keys(topicData.categories).sort().forEach(categoryName => {
                    const categoryData = topicData.categories[categoryName];
                    const categoryItem = createTreeItem(categoryName, categoryData.count, 2, () => handleCategoryClick(topicName, categoryName));
                    childrenContainer.appendChild(categoryItem);

                    // Create children container for items under category
                    const itemsContainer = document.createElement('div');
                    itemsContainer.className = 'tree-children';
                    itemsContainer.id = `children-${topicName}-${categoryName}`;

                    Object.keys(categoryData.items).sort().forEach(itemName => {
                        const itemCount = categoryData.items[itemName];
                        const itemElement = createTreeItem(itemName, itemCount, 3, () => handleItemClick(topicName, categoryName, itemName));
                        itemsContainer.appendChild(itemElement);
                    });

                    childrenContainer.appendChild(itemsContainer);
                });

                topicTree.appendChild(childrenContainer);
            });

            // Populate essay types with counts
            const essayTypeCounts = {};
            allEssays.forEach(essay => {
                if (essay.EssayType) {
                    essay.EssayType.forEach(type => {
                        if (!essayTypeCounts[type]) {
                            essayTypeCounts[type] = 0;
                        }
                        essayTypeCounts[type]++;
                    });
                }
            });

            const essayTypeTree = document.getElementById('essayTypeTree');
            essayTypeTree.innerHTML = '';
            // Sort essay types by count (descending)
            Object.keys(essayTypeCounts).sort((a, b) => essayTypeCounts[b] - essayTypeCounts[a]).forEach(type => {
                const count = essayTypeCounts[type];
                const item = createTreeItem(type, count, 1, () => handleEssayTypeClick(type));
                essayTypeTree.appendChild(item);
            });

            // Populate audiences with counts
            const audienceCounts = {};
            allEssays.forEach(essay => {
                if (essay.Audience) {
                    essay.Audience.forEach(aud => {
                        if (!audienceCounts[aud]) {
                            audienceCounts[aud] = 0;
                        }
                        audienceCounts[aud]++;
                    });
                }
            });

            const audienceTree = document.getElementById('audienceTree');
            audienceTree.innerHTML = '';
            // Sort audiences by count (descending)
            Object.keys(audienceCounts).sort((a, b) => audienceCounts[b] - audienceCounts[a]).forEach(audience => {
                const count = audienceCounts[audience];
                const item = createTreeItem(audience, count, 1, () => handleAudienceClick(audience));
                audienceTree.appendChild(item);
            });
        }

        function renderList(essays) {
            const container = document.getElementById('essayList');
            const countDiv = document.getElementById('essayCount');

            countDiv.innerHTML = `Showing ${essays.length} essays`;

            if (essays.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 2rem; color: #718096;">No essays found. Start bookmarking essays to create your reading list!</p>';
                return;
            }

            container.innerHTML = '';

            essays.forEach(essay => {
                const item = document.createElement('div');
                item.className = 'essay-item';

                // Create bookmark button
                const bookmarkBtn = document.createElement('button');
                bookmarkBtn.className = 'bookmark-btn' + (isBookmarked(essay.Title) ? ' bookmarked' : '');
                bookmarkBtn.innerHTML = isBookmarked(essay.Title) ? '★' : '☆';
                bookmarkBtn.setAttribute('data-title', essay.Title);
                bookmarkBtn.onclick = (e) => {
                    e.stopPropagation();
                    toggleBookmark(essay.Title);
                };

                // Create title
                const title = document.createElement('div');
                title.className = 'essay-title';
                title.textContent = essay.Title;

                // Create tags container
                const tagsContainer = document.createElement('div');
                tagsContainer.className = 'essay-tags';

                // Add date tag
                const dateTag = document.createElement('span');
                dateTag.className = 'tag date-tag';
                dateTag.textContent = essay.Date;
                tagsContainer.appendChild(dateTag);

                // Add reading time tag
                const timeTag = document.createElement('span');
                timeTag.className = 'tag time-tag';
                timeTag.textContent = essay.ReadingTime + ' min';
                tagsContainer.appendChild(timeTag);

                // Add topic tags
                essay.Topics.forEach(topic => {
                    const topicTag = document.createElement('span');
                    topicTag.className = 'tag topic-tag';
                    topicTag.textContent = topic.topic;
                    tagsContainer.appendChild(topicTag);
                });

                // Create content wrapper
                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'essay-content';
                contentWrapper.appendChild(title);
                contentWrapper.appendChild(tagsContainer);

                // Assemble the item
                item.appendChild(bookmarkBtn);
                item.appendChild(contentWrapper);

                // Add click handler to open preview
                item.onclick = (e) => {
                    if (e.target.classList.contains('bookmark-btn')) {
                        return;
                    }
                    openPreview(essay);
                };

                container.appendChild(item);
            });
        }

        // ========== LOAD DATA ==========

        fetch('./essays.json')
            .then(response => response.json())
            .then(data => {
                allEssays = data.essays;
                populateFilters();
                updateSortBadges(); // Show initial sort badge
                applySortAndFilter();
            })
            .catch(error => {
                console.error('Error loading essays:', error);
                document.getElementById('essayList').innerHTML =
                    '<p style="text-align: center; padding: 2rem; color: #e53e3e;">Error loading essays. Please refresh the page.</p>';
            });
    </script>
</body>
</html>
